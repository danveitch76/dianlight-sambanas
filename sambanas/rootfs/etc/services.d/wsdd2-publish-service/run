#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start avahi service
# ==============================================================================
declare SMB_GROUP
declare SMB_HOST
declare SMB_DOMAIN


#SMB_GROUP=$(grep -i '^\s*workgroup\s*=' /etc/samba/smb.conf | cut -f2 -d= | tr -d '[:blank:]')
SMB_HOST=$(grep -i '^\s*netbios name\s*=' /etc/samba/smb.conf | cut -f2 -d= | tr -d '[:blank:]')

#bashio::log.info "Starting the WSDD daemon for ${SMB_GROUP}/${SMB_HOST}..."
bashio::log.info "Starting the WSDD2 daemon for ${SMB_HOST}..."

if bashio::config.has_value 'interfaces'; then
    bashio::log.info "Interfaces from config: $(bashio::config 'interfaces')"
    for interface in $(bashio::config 'interfaces'); do
        if [ -d "/sys/class/net/${interface}" ]; then
            interfaces+=("-i ${interface}")
        else
            bashio::log.warning "Interface ${interface} not found, skipping."
        fi
    done   
else
    # Get supported interfaces
    for interface in $(bashio::network.interfaces); do
        interfaces+=("-i ${interface}")
    done
fi

if [ ${#interfaces[@]} -eq 0 ]; then
    bashio::exit.nok 'No supported interfaces found to bind on.'
fi
bashio::log.info "Interfaces: $(printf '%s ' "${interfaces[@]}")"

#exec wsdd -v $(printf '%s ' "${interfaces[@]}") -n ${SMB_HOST} -w ${SMB_GROUP}
exec /usr/sbin/wsdd2 -W -W -t -u -w  $(printf '%s ' "${interfaces[@]}") -H ${SMB_HOST}